# -*- coding: utf-8 -*-
"""bancosapp.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ZftL7qKlkxNAimQTF4tQpmGrIpw7Xx5n
"""

import streamlit as st
import yfinance as yf
import pandas as pd
from PIL import Image
import requests
from io import BytesIO
import time

# Dicion√°rio com dados dos bancos
bancos = {
    'BBDC4.SA': {
        'empresa': 'Banco Bradesco',
        'ticker': 'BBDC4',
        'logo_path': 'logos/bradesco.png'
    },
    'BBAS3.SA': {
        'empresa': 'Banco do Brasil',
        'ticker': 'BBAS3',
        'logo_path': 'logos/bb.png'
    },
    'ITUB4.SA': {
        'empresa': 'Ita√∫ Unibanco',
        'ticker': 'ITUB4',
        'logo_path': 'logos/itau.png'
    },
    'SANB11.SA': {
        'empresa': 'Banco Santander',
        'ticker': 'SANB11',
        'logo_path': 'logos/santander.png'
    }
}

def buscar_preco(ticker):
    try:
        stock = yf.Ticker(ticker)
        hist = stock.history(period="1d", interval="1m")
        if not hist.empty:
            return round(hist["Close"].iloc[-1], 2)
    except:
        pass
    return "N/A"

st.set_page_config(page_title="Pre√ßos em tempo real - Bancos", layout="wide")
st.title("üìä Pre√ßo em Tempo Real das A√ß√µes - Bancos B3")

refresh_interval = st.slider("‚è±Ô∏è Atualizar a cada quantos segundos?", min_value=1, max_value=60, value=1)

# Placeholder para atualiza√ß√£o da tabela
placeholder = st.empty()

# Dicion√°rio para guardar o √∫ltimo pre√ßo conhecido
precos_anteriores = {ticker: None for ticker in bancos.keys()}

while True:
    with placeholder.container():
        # Cabe√ßalho da tabela
        col1, col2, col3, col4, col5 = st.columns([1.5, 3, 2, 2, 1])
        with col1: st.markdown("**LOGO**")
        with col2: st.markdown("**EMPRESA**")
        with col3: st.markdown("**TICKER**")
        with col4: st.markdown("**PRE√áO DA A√á√ÉO (R$)**")
        with col5: st.markdown("**TEND√äNCIA**")

        for ticker, info in bancos.items():
            preco_atual = buscar_preco(ticker)
            preco_ant = precos_anteriores[ticker]

            # Decide o emoji de tend√™ncia
            if preco_ant is None or preco_atual == "N/A" or preco_ant == "N/A":
                tendencia = ""
            elif preco_atual > preco_ant:
                tendencia = "üî∫"
            elif preco_atual < preco_ant:
                tendencia = "üîª"
            else:
                tendencia = "-"

            precos_anteriores[ticker] = preco_atual

            col1, col2, col3, col4, col5 = st.columns([1.5, 3, 2, 2, 1])
            with col1:
                st.image(info["logo_path"], width=100)
            with col2:
                st.markdown(f"<div style='display:flex; align-items:center; height:100%;'>{info['empresa']}</div>", unsafe_allow_html=True)
            with col3:
                st.markdown(f"<div style='display:flex; align-items:center; height:100%;'>{info['ticker']}</div>", unsafe_allow_html=True)
            with col4:
                st.markdown(f"<div style='display:flex; align-items:center; height:100%;'>R$ {preco_atual}</div>", unsafe_allow_html=True)
            with col5:
                st.markdown(f"<div style='display:flex; align-items:center; height:100%; font-size:24px;'>{tendencia}</div>", unsafe_allow_html=True)

from openai import OpenAI
import os

# configure sua chave
os.environ["OPENAI_API_KEY"] = "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"
client = OpenAI()

def analisar_bbdc4_com_openai(df):
    csv_text = df.to_csv(index=True)

    prompt = f"""
Abaixo est√° o hist√≥rico do pre√ßo de fechamento da a√ß√£o BBDC4 nos √∫ltimos 5 minutos (1 minuto por linha):
{csv_text}

Com base nesses dados, fa√ßa uma an√°lise muito curta do comportamento do pre√ßo, diga se parece ter tend√™ncia de alta ou baixa e, principalmente, d√™ uma recomenda√ß√£o clara:
- Escreva no final apenas "RECOMENDA√á√ÉO: SIM" se valeria a pena comprar agora visando o pr√≥ximo 5 minutos.
- Ou escreva apenas "RECOMENDA√á√ÉO: N√ÉO" se n√£o vale a pena comprar.
"""

    response = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[{"role": "user", "content": prompt}]
    )

    return response.choices[0].message.content

def mostrar_historico_bbdc4():
    st.header("üìà Hist√≥rico do Banco Bradesco - √∫ltimos 5 minutos")
    try:
        ticker = 'BBDC4.SA'
        stock = yf.Ticker(ticker)
        hist = stock.history(period="5m", interval="1m")

        if not hist.empty:
            df = hist[['Close']].rename(columns={"Close": "Pre√ßo"})
            st.line_chart(df)

            if st.button("üîé Pedir an√°lise e recomenda√ß√£o da IA"):
                with st.spinner("IA est√° analisando o hist√≥rico..."):
                    analise = analisar_bbdc4_com_openai(df)

                st.subheader("üìä An√°lise da IA")
                st.write(analise)

                # Procurar a recomenda√ß√£o final
                if "RECOMENDA√á√ÉO: SIM" in analise.upper():
                    st.success("‚úÖ RECOMENDA√á√ÉO FINAL DA IA: SIM")
                elif "RECOMENDA√á√ÉO: N√ÉO" in analise.upper():
                    st.warning("üö´ RECOMENDA√á√ÉO FINAL DA IA: N√ÉO")
                else:
                    st.info("‚ÑπÔ∏è IA n√£o deu uma recomenda√ß√£o clara.")
        else:
            st.write("Sem dados recentes para exibir o hist√≥rico.")
    except Exception as e:
        st.error(f"Erro ao obter dados: {e}")

    time.sleep(refresh_interval)

if st.checkbox("üìä Mostrar hist√≥rico e recomenda√ß√£o para o Banco Bradesco"):
    mostrar_historico_bbdc4()
