# -*- coding: utf-8 -*-
"""bancosapp.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ZftL7qKlkxNAimQTF4tQpmGrIpw7Xx5n
"""
import streamlit as st
import yfinance as yf
import pandas as pd
from PIL import Image
import requests
from io import BytesIO
import time
from openai import OpenAI
import os

# Instancia o cliente da OpenAI de forma segura usando os segredos do Streamlit
try:
    client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])
except Exception as e:
    st.error("Chave da API da OpenAI nÃ£o encontrada. Por favor, configure o arquivo .streamlit/secrets.toml.")
    st.stop() # Interrompe a execuÃ§Ã£o se a chave nÃ£o for encontrada

# DicionÃ¡rio com dados dos bancos
bancos = {
    'BBDC4.SA': {
        'empresa': 'Banco Bradesco',
        'ticker': 'BBDC4',
        'logo_path': 'logos/bradesco.png'
    },
    'BBAS3.SA': {
        'empresa': 'Banco do Brasil',
        'ticker': 'BBAS3',
        'logo_path': 'logos/bb.png'
    },
    'ITUB4.SA': {
        'empresa': 'ItaÃº Unibanco',
        'ticker': 'ITUB4',
        'logo_path': 'logos/itau.png'
    },
    'SANB11.SA': {
        'empresa': 'Banco Santander',
        'ticker': 'SANB11',
        'logo_path': 'logos/santander.png'
    }
}

def buscar_preco(ticker):
    try:
        stock = yf.Ticker(ticker)
        hist = stock.history(period="1d", interval="1m")
        if not hist.empty:
            return round(hist["Close"].iloc[-1], 2)
    except:
        pass
    return "N/A"

def analisar_historico_com_openai(df, ticker):
    """Envia o histÃ³rico de preÃ§os para a IA e retorna a anÃ¡lise."""
    csv_text = df.to_csv(index=True)
    prompt = f"""
    Aja como um analista de trading de curto prazo.
    Abaixo estÃ¡ o histÃ³rico de preÃ§o de fechamento da aÃ§Ã£o {ticker} a cada minuto, nos Ãºltimos minutos:
    ---
    {csv_text}
    ---
    Com base exclusivamente nesta curta tendÃªncia de preÃ§os, faÃ§a uma anÃ¡lise tÃ©cnica muito breve (1-2 linhas) e objetiva.
    Ao final, determine se hÃ¡ uma indicaÃ§Ã£o de COMPRA ou VENDA para os prÃ³ximos 5 minutos.

    Sua resposta final DEVE conter apenas uma das seguintes linhas, sem texto adicional:
    RECOMENDAÃ‡ÃƒO: COMPRAR
    ou
    RECOMENDAÃ‡ÃƒO: VENDER
    ou
    RECOMENDAÃ‡ÃƒO: MANTER
    """
    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[{"role": "user", "content": prompt}]
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"Erro ao contatar a API da OpenAI: {e}"

def mostrar_historico_e_analise(ticker_analise, nome_empresa):
    """Exibe o grÃ¡fico de histÃ³rico e o botÃ£o para anÃ¡lise da IA."""
    st.header(f"ðŸ“ˆ AnÃ¡lise de Curto Prazo: {nome_empresa}")
    
    # Busca um perÃ­odo maior para ter um grÃ¡fico mais Ãºtil (ex: Ãºltimos 60 minutos)
    hist = yf.Ticker(ticker_analise).history(period="10m", interval="1m")

    if not hist.empty:
        df = hist[['Close']].rename(columns={"Close": "PreÃ§o (R$)"})
        st.line_chart(df)

        if st.button(f"ðŸ”Ž Analisar {ticker_analise} com IA"):
            # Para a anÃ¡lise, usamos apenas os Ãºltimos 5 minutos de dados
            df_analise = df.tail(5)
            with st.spinner("IA analisando os Ãºltimos 5 minutos de dados..."):
                analise = analisar_historico_com_openai(df_analise, ticker_analise)
            
            st.subheader("ðŸ¤– AnÃ¡lise da IA")
            st.write(analise)
            
            # Extrai a recomendaÃ§Ã£o final de forma mais robusta
            if "COMPRAR" in analise.upper():
                st.success("âœ… RECOMENDAÃ‡ÃƒO FINAL DA IA: COMPRAR")
            elif "VENDER" in analise.upper():
                st.error("âŒ RECOMENDAÃ‡ÃƒO FINAL DA IA: VENDER")
            elif "MANTER" in analise.upper():
                st.warning("ï¸neutral_face: RECOMENDAÃ‡ÃƒO FINAL DA IA: MANTER/NEUTRO")
            else:
                st.info("â„¹ï¸ A IA nÃ£o forneceu uma recomendaÃ§Ã£o clara.")
    else:
        st.write("Sem dados recentes para exibir o histÃ³rico.")

st.set_page_config(page_title="PreÃ§os em tempo real - Bancos", layout="wide")
st.title("ðŸ“Š PreÃ§o em Tempo Real das AÃ§Ãµes - Bancos B3")
refresh_interval = st.slider("â±ï¸ Atualizar a cada quantos segundos?", min_value=1, max_value=60, value=1)

# Placeholder para atualizaÃ§Ã£o da tabela
placeholder = st.empty()

# DicionÃ¡rio para guardar o Ãºltimo preÃ§o conhecido e evitar piscar a tendÃªncia
if 'precos_anteriores' not in st.session_state:
    st.session_state.precos_anteriores = {ticker: None for ticker in bancos.keys()}

# Exibe a seÃ§Ã£o de anÃ¡lise da IA para o Bradesco
mostrar_historico_e_analise('BBDC4.SA', 'Banco Bradesco')

st.header("Monitor de PreÃ§os em Tempo Real")

while True:
    with placeholder.container():
        # CabeÃ§alho da tabela
        col1, col2, col3, col4, col5 = st.columns([1.5, 3, 2, 2, 1])
        with col1: st.markdown("**LOGO**")
        with col2: st.markdown("**EMPRESA**")
        with col3: st.markdown("**TICKER**")
        with col4: st.markdown("**PREÃ‡O DA AÃ‡ÃƒO (R$)**")
        with col5: st.markdown("**TENDÃŠNCIA**")

        for ticker, info in bancos.items():
            preco_atual = buscar_preco(ticker)
            preco_ant = precos_anteriores[ticker]

            # Decide o emoji de tendÃªncia
            if preco_ant is None or preco_atual == "N/A" or preco_ant == "N/A":
                tendencia = ""
            elif preco_atual > preco_ant:
                tendencia = "ðŸ”º"
            elif preco_atual < preco_ant:
                tendencia = "ðŸ”»"
            else:
                tendencia = "-"

            precos_anteriores[ticker] = preco_atual

            col1, col2, col3, col4, col5 = st.columns([1.5, 3, 2, 2, 1])
            with col1:
                st.image(info["logo_path"], width=100)
            with col2:
                st.markdown(f"<div style='display:flex; align-items:center; height:100%;'>{info['empresa']}</div>", unsafe_allow_html=True)
            with col3:
                st.markdown(f"<div style='display:flex; align-items:center; height:100%;'>{info['ticker']}</div>", unsafe_allow_html=True)
            with col4:
                st.markdown(f"<div style='display:flex; align-items:center; height:100%;'>R$ {preco_atual}</div>", unsafe_allow_html=True)
            with col5:
                st.markdown(f"<div style='display:flex; align-items:center; height:100%; font-size:24px;'>{tendencia}</div>", unsafe_allow_html=True)

    time.sleep(refresh_interval)
